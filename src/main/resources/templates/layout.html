<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">

<head>
    <meta charset="UTF-8">
    <title layout:fragment="title">Parking Finder</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <link rel="stylesheet" th:href="@{/style.css}">
    <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f8f9fa;
        }

        h1 {
            margin-bottom: 30px;
        }

        .lot-list {
            padding-left: 0;
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" th:href="@{/}">
                <img th:src="@{/images/logo.svg}" width="30" height="30" class="d-inline-block align-top" alt="">
                Parking Finder TLV
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarToggler"
                aria-controls="navbarToggler" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarToggler">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link" th:classappend="${activeTab} == 'home' ? ' active' : ''"
                            th:href="@{/}">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" th:classappend="${activeTab} == 'about' ? ' active' : ''"
                            th:href="@{/about}">About</a>
                    </li>
                </ul>
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item dropdown" th:if="${user != null}">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown"
                            aria-expanded="false">
                            <i class="bi bi-person-circle"></i>
                            <span th:text="${user.email}">User</span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><h6 class="dropdown-header" th:text="${user.email}">User Email</h6></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" th:href="@{/settings}"><i class="bi bi-gear"></i> Settings</a></li>
                            <li><a class="dropdown-item" th:href="@{/logout}"><i class="bi bi-box-arrow-right"></i> Logout</a></li>
                        </ul>
                    </li>
                    <li class="nav-item" th:if="${user == null}">
                        <a class="nav-link" th:href="@{/login}">
                            <i class="bi bi-box-arrow-in-right"></i> Login
                        </a>
                    </li>
                    <li class="nav-item" th:if="${user == null}">
                        <a class="nav-link" th:href="@{/register}">
                            <i class="bi bi-person-plus"></i> Register
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Slot for child content -->
    <main layout:fragment="content"></main>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    
    <script th:src="@{/script.js}"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q"
        crossorigin="anonymous"></script>
    
    <!-- Firebase configuration for auth pages -->
    <script th:if="${firebaseConfig != null}" th:inline="javascript">
        const firebaseConfig = /*[[${firebaseConfig}]]*/ {};
        console.log('Firebase config loaded:', firebaseConfig);
        
        if (firebaseConfig.apiKey && firebaseConfig.apiKey !== '') {
            if (typeof firebase !== 'undefined') {
                firebase.initializeApp(firebaseConfig);
            }
        }
        
        // Registration page specific code
        if (window.location.pathname === '/register') {
            console.log('Registration page detected, setting up handlers...');
            
            // Wait for DOM to be fully loaded
            document.addEventListener('DOMContentLoaded', function() {
                console.log('DOM fully loaded on registration page');
                
                const form = document.getElementById('registrationForm');
                const button = document.getElementById('registerBtn');
                
                console.log('Form element:', form);
                console.log('Button element:', button);
                
                if (form) {
                    form.addEventListener('submit', function(e) {
                        console.log('Form submit event triggered');
                        e.preventDefault();
                        handleRegistration();
                    });
                }
                
                if (button) {
                    console.log('Button found, adding click listener');
                    button.addEventListener('click', function(e) {
                        console.log('Button click event triggered');
                        e.preventDefault();
                        handleRegistration();
                    });
                    
                    // Test if button is clickable
                    button.onclick = function() {
                        console.log('Button onclick triggered');
                    };
                } else {
                    console.error('Button element not found!');
                }
            });
            
            // Handle form submission
            function handleRegistration() {
                console.log('Registration handler called');
                console.log('Firebase config:', firebaseConfig);
                console.log('Firebase apps:', firebase.apps);
                console.log('Firebase object:', typeof firebase);
                console.log('firebase.auth:', typeof firebase.auth);
                
                // Check if Firebase is initialized
                if (!firebase.apps.length) {
                    showError('Firebase is not initialized. Please check your configuration.');
                    return;
                }
                
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                const confirmPassword = document.getElementById('confirmPassword').value;
                
                console.log('Registration data:', { email, password: password ? '***' : 'empty', confirmPassword: confirmPassword ? '***' : 'empty' });
                
                // Hide any existing messages
                hideMessages();
                
                // Validate passwords match
                if (password !== confirmPassword) {
                    showError('Passwords do not match');
                    return;
                }
                
                // Validate password length
                if (password.length < 6) {
                    showError('Password must be at least 6 characters long');
                    return;
                }
                
                // Disable button and show loading state
                const registerBtn = document.getElementById('registerBtn');
                const originalText = registerBtn.innerHTML;
                registerBtn.disabled = true;
                registerBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Creating Account...';
                
                // Create user with Firebase Auth
                firebase.auth().createUserWithEmailAndPassword(email, password)
                    .then((userCredential) => {
                        const user = userCredential.user;
                        showSuccess('Account created successfully! Redirecting to login...');
                        
                        // Redirect to login after a short delay
                        setTimeout(() => {
                            window.location.href = '/login?message=Account created successfully! You can now sign in.';
                        }, 2000);
                    })
                                    .catch((error) => {
                    console.log('Firebase error:', error);
                    console.log('Error code:', error.code);
                    console.log('Error message:', error.message);
                    
                    let errorMessage = 'An error occurred during registration';
                    
                    switch (error.code) {
                        case 'auth/email-already-in-use':
                            errorMessage = 'An account with this email already exists';
                            break;
                        case 'auth/invalid-email':
                            errorMessage = 'Please enter a valid email address';
                            break;
                        case 'auth/weak-password':
                            errorMessage = 'Password is too weak. Please choose a stronger password (at least 6 characters)';
                            break;
                        case 'auth/network-request-failed':
                            errorMessage = 'Network error. Please check your internet connection';
                            break;
                        case 'auth/operation-not-allowed':
                            errorMessage = 'Email/password accounts are not enabled. Please contact support.';
                            break;
                        default:
                            errorMessage = `Registration failed: ${error.message}`;
                    }
                    
                    showError(errorMessage);
                })
                    .finally(() => {
                        // Re-enable button
                        registerBtn.disabled = false;
                        registerBtn.innerHTML = originalText;
                    });
            }
            
            function showError(message) {
                const errorDiv = document.getElementById('errorMessage');
                const errorText = document.getElementById('errorText');
                errorText.textContent = message;
                errorDiv.classList.remove('d-none');
                errorDiv.scrollIntoView({ behavior: 'smooth' });
            }
            
            function showSuccess(message) {
                const successDiv = document.getElementById('successMessage');
                const successText = document.getElementById('successText');
                successText.textContent = message;
                successDiv.classList.remove('d-none');
                successDiv.scrollIntoView({ behavior: 'smooth' });
            }
            
            function hideMessages() {
                document.getElementById('errorMessage').classList.add('d-none');
                document.getElementById('successMessage').classList.add('d-none');
            }
        }
        
        // Login page specific code
        if (window.location.pathname === '/login') {
            console.log('Login page detected, setting up handlers...');
            
            // Wait for DOM to be fully loaded
            document.addEventListener('DOMContentLoaded', function() {
                console.log('DOM fully loaded on login page');
                
                const form = document.getElementById('loginForm');
                const button = document.getElementById('loginBtn');
                
                console.log('Login form element:', form);
                console.log('Login button element:', button);
                
                if (form) {
                    form.addEventListener('submit', function(e) {
                        console.log('Login form submit event triggered');
                        e.preventDefault();
                        handleLogin();
                    });
                }
                
                if (button) {
                    console.log('Login button found, adding click listener');
                    button.addEventListener('click', function(e) {
                        console.log('Login button click event triggered');
                        e.preventDefault();
                        handleLogin();
                    });
                } else {
                    console.error('Login button element not found!');
                }
            });
            
            // Handle login form submission
            function handleLogin() {
                console.log('Login handler called');
                
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                
                console.log('Login data:', { email, password: password ? '***' : 'empty' });
                
                // Hide any existing messages
                hideLoginMessages();
                
                // Disable button and show loading state
                const loginBtn = document.getElementById('loginBtn');
                const originalText = loginBtn.innerHTML;
                loginBtn.disabled = true;
                loginBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Signing In...';
                
                // Sign in with Firebase Auth
                firebase.auth().signInWithEmailAndPassword(email, password)
                    .then((userCredential) => {
                        const user = userCredential.user;
                        console.log('Firebase login successful:', user.email);
                        
                        // Get the ID token
                        return user.getIdToken();
                    })
                    .then((idToken) => {
                        console.log('Got ID token, sending to backend...');
                        // Send the token to your backend for verification
                        return fetch('/auth/verify', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                idToken: idToken
                            })
                        });
                    })
                    .then((response) => {
                        console.log('Backend response status:', response.status);
                        if (response.ok) {
                            console.log('Login successful, redirecting to home...');
                            // Redirect to home page
                            window.location.href = '/';
                        } else {
                            throw new Error('Authentication failed');
                        }
                    })
                    .catch((error) => {
                        console.log('Login error:', error);
                        console.log('Error code:', error.code);
                        console.log('Error message:', error.message);
                        
                        let errorMessage = 'An error occurred during sign in';
                        
                        switch (error.code) {
                            case 'auth/user-not-found':
                                errorMessage = 'No account found with this email address';
                                break;
                            case 'auth/wrong-password':
                                errorMessage = 'Incorrect password';
                                break;
                            case 'auth/invalid-email':
                                errorMessage = 'Please enter a valid email address';
                                break;
                            case 'auth/user-disabled':
                                errorMessage = 'This account has been disabled';
                                break;
                            case 'auth/too-many-requests':
                                errorMessage = 'Too many failed attempts. Please try again later';
                                break;
                            case 'auth/network-request-failed':
                                errorMessage = 'Network error. Please check your internet connection';
                                break;
                            default:
                                errorMessage = `Login failed: ${error.message}`;
                        }
                        
                        showLoginError(errorMessage);
                    })
                    .finally(() => {
                        // Re-enable button
                        loginBtn.disabled = false;
                        loginBtn.innerHTML = originalText;
                    });
            }
            
            function showLoginError(message) {
                const errorDiv = document.getElementById('errorMessage');
                const errorText = document.getElementById('errorText');
                errorText.textContent = message;
                errorDiv.classList.remove('d-none');
                errorDiv.scrollIntoView({ behavior: 'smooth' });
            }
            
            function hideLoginMessages() {
                document.getElementById('errorMessage').classList.add('d-none');
            }
        }
    </script>
</body>

</html>